<%
    misc = @trans.t.misc
%>
function page_init() {
    up = function() { window.location = '/'; }

    const datasets = Array.from(document.querySelectorAll('h2'), s => s.dataset);
    const fetch_promises = datasets.map(function(d) {
        let url = '/api/4/';
        if (d.value) {
            url += 'tag/overview?key=' + encodeURIComponent(d.key) + '&value=' + encodeURIComponent(d.value);
        } else {
            url += 'key/overview?key=' + encodeURIComponent(d.key);
        }

        return fetch(url).then(response => response.json());
    });

    Promise.all(fetch_promises).then(r => data_complete(r.map(d => d.data)));
}

function data_complete(data) {
    set_comparison_list(data.map(function(d) {
        if (d.value === undefined) {
            d.value = null;
        }
        return [d.key, d.value];
    }));

    jQuery.each(data, function(index, item) {
        let datac = [];
        jQuery.each(data, function(i, item) {
            if (i != index) {
                datac.push([item['key'], item['value']]);
            }
        });
        jQuery('.item' + index + ' a.close').attr('href', comparison_list_url(datac));
        if (item.value) {
            jQuery('.item' + index + ' h2').html(link_to_tag(item.key, item.value));
        } else {
            jQuery('.item' + index + ' h2').html(link_to_key(item.key));
            if (item.prevalent_values) {
                jQuery('.item' + index + '.prevalent_values div b').text('<%= h(misc.prevalent_values) %>:');
                jQuery('.item' + index + '.prevalent_values div.data').html(fmt_prevalent_value_list(item.key, item.prevalent_values));
            }
        }
        jQuery('.item' + index + '.projects div').append(item.projects);
        jQuery('.item' + index + '.counts table td').each(function(index, c) {
            c.innerHTML = fmt_with_ts(item.counts[index].count);
        });
        jQuery('.item' + index + '.wiki div.data').append(item.wiki_pages.map(
            w => tag('span', html_escape(w.lang), {
                'class': 'badge lang',
                title: html_escape(w.native + ' (' + w.english + ')')
            })
        ).join(' '));
    });
    jQuery('div.prevalent_values a').tipsy({ opacity: 1, delayIn: 500, gravity: 'w' });
    jQuery('span.lang').tipsy({ opacity: 1, delayIn: 500, gravity: 'n' });
}
