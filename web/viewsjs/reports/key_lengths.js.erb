<%
    osm = @trans.t.osm
    misc = @trans.t.misc
    page = @trans.t.reports.key_lengths

    hist = []
    max_length = 60
    @db.execute("SELECT min(length(key), #{ max_length }) AS length, count(*) AS count FROM db.keys GROUP BY 1 ORDER BY 1") do |row|
        hist[row['length'].to_i] = row['count'].to_i
    end
    hist = hist.map{ |item| item.nil? ? 0 : item }
%>

class ChartKeyLengthHistogram {
    data;
    max;

    constructor(data, max) {
        this.data = data;
        this.max = max;
    }

    draw() {
        const barWidth = 6;
        const barSkip = 2;
        const barStep = barWidth + barSkip;
        const width = barStep * this.data.length;
        const height = Math.min(400, document.getElementById('tabs').getBoundingClientRect().height - 160);
        const margin = { top: 10, right: 15, bottom: 60, left: 60 };

        const scaleY = d3.scaleLinear()
                        .domain([0, this.max])
                        .range([height, 0]);

        const chart = d3.select('#canvas-histogram').append('svg')
                        .attr('width', width + margin.left + margin.right)
                        .attr('height', height + margin.top + margin.bottom)
                        .append('g')
                            .attr('transform', 'translate(' + margin.left + ', ' + margin.top + ')')
                            .call(function(c) {
                                c.append('rect')
                                    .attr('width', width)
                                    .attr('height', height + 10)
                                    .attr('y', -5)
                                    .style('fill', 'white')
                                    .style('stroke', '#d0d0c8')
                            });

        chart.append('g')
            .attr('class', 'x axis')
            .attr('transform', 'translate(0, ' + (height + 10) + ')')
            .append('text')
                .attr('x', width / 2)
                .attr('y', 36)
                .style('text-anchor', 'middle')
                .text('<%= page.histogram.key_length %>');

        chart.append('g')
            .attr('class', 'y axis')
            .style('fill', 'black')
            .call(d3.axisLeft(scaleY))
            .append('text')
                .attr('transform', 'rotate(-90)')
                .attr('x', -height / 2)
                .attr('y', -50)
                .style('text-anchor', 'middle')
                .text('<%= page.histogram.number_of_keys %>');

        chart.selectAll('rect')
            .data(this.data)
            .enter()
            .append('g')
                .call(function(c) {
                    c.append('g')
                        .attr('transform', function(d, i) { return 'translate(' + (i * barStep + barStep / 2) + ', ' + (height + 10) + ')';})
                        .style('display', function(d, i) { return i == 1 || i % 10 == 0 ? '' : 'none'; })
                        .call(function(t) {
                            t.append('text')
                                .attr('y', 16)
                                .style('text-anchor', 'middle')
                                .text((d, i) => i == <%= max_length %> ? '>=' + <%= max_length %> : i)
                        })
                        .append('line')
                            .style('stroke', 'black')
                            .style('shape-rendering', 'crispEdges')
                            .attr('y2', 6);
                })
            .append('rect')
                .style('fill', '#083e76')
                .attr('x', (d, i) => i * barStep)
                .attr('y', d => scaleY(d))
                .attr('width', barWidth)
                .attr('height', d => height - scaleY(d))
                .attr('title', (d, i) => '' + d + ' keys of length ' + i);

    }

} // class ChartKeyLengthHistogram

const tabsConfig = {
    keys: function() {
        return new DynamicTable('grid-keys', {
            url: '/api/4/keys/all',
            params: { include: 'prevalent_values' },
            colModel: [
                { display: '<%= h(misc.length) %>', name: 'length', width: 60, sortable: true, align: 'right' },
                { display: '<%= h(osm.key) %>', name: 'key', width: 180, sortable: true },
                { display: '<img src="/img/types/all.svg" width="16" height="16" alt=""/> <%= h(osm.objects) %>', name: 'count_all', width: 200, sortable: true, align: 'center', title: '<%= h(misc.objects_tooltip) %>' },
                { display: '<%= h(@trans.t.taginfo.wiki) %>', name: 'in_wiki', width: 20, sortable: true, align: 'center', title: '<%= h(misc.in_wiki_tooltip) %>' },
                { display: '<%= h(osm.values) %>', name: 'values_all', width: 70, sortable: true, align: 'right', title: '<%= h(misc.values_tooltip) %>' },
                { display: '<%= h(misc.prevalent_values) %>', name: 'prevalent_values', width: 550, sortable: true, title: '<%= h(misc.prevalent_values_tooltip) %>' }
            ],
            searchitems: [
                { display: '<%= h(osm.key) %>', name: 'key' }
            ],
            sortname: 'length',
            sortorder: 'asc',
            preProcess: function(data) {
                data.rows = data.data.map(function(row) {
                    return { 'cell': [
                        row.key.length,
                        link_to_key(row.key),
                        fmt_value_with_percent(row.count_all, row.count_all_fraction),
                        link_to_key_with_tab(row.key, 'wiki', fmt_checkmark(row.in_wiki)),
                        fmt_with_ts(row.values_all),
                        fmt_prevalent_value_list(row.key, row.prevalent_values)
                    ] };
                });
                return data;
            }
        });
    },
    histogram: function() {
        const data = <%= hist.to_json %>;
        const max = <%= hist.max %>;
        const chart = new ChartKeyLengthHistogram(data, max);
        chart.draw();
    }
};

function page_init() {
    up = function() { window.location = build_link('/reports'); };
    initTabs(tabsConfig);
}
